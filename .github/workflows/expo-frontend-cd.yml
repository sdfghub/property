name: expo-frontend-cd
on:
  workflow_dispatch:
env:
  AWS_REGION: eu-central-1
  STACK_NAME: PropertyExpenses-Frontend
  FRONTEND_CERT_ARN: ${{ vars.FRONTEND_CERT_ARN }}
  FRONTEND_DOMAIN: ${{ vars.FRONTEND_DOMAIN }}
  EXPO_PUBLIC_API_BASE: ${{ vars.EXPO_PUBLIC_API_BASE }}
  FRONTEND_API_BASE: ${{ vars.FRONTEND_API_BASE }}
  API_DOMAIN: ${{ vars.API_DOMAIN }}
  APP_STACK_NAME: PropertyExpenses-App
jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions: { contents: read, id-token: write }
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: '20' }
      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
      - name: Build CDK
        run: |
          cd infra/cdk
          npm ci
          npm run build
      - name: Deploy frontend stack
        run: |
          cd infra/cdk
          FRONTEND_CERT_ARN=${FRONTEND_CERT_ARN} FRONTEND_DOMAIN="${FRONTEND_DOMAIN}" npx cdk deploy ${STACK_NAME} --require-approval never
      - name: Resolve API base
        run: |
          if [ -n "${EXPO_PUBLIC_API_BASE}" ]; then
            echo "EXPO_PUBLIC_API_BASE=${EXPO_PUBLIC_API_BASE}" >> $GITHUB_ENV
            exit 0
          fi
          if [ -n "${FRONTEND_API_BASE}" ]; then
            echo "EXPO_PUBLIC_API_BASE=${FRONTEND_API_BASE}" >> $GITHUB_ENV
            exit 0
          fi
          if [ -n "${API_DOMAIN}" ]; then
            echo "EXPO_PUBLIC_API_BASE=https://${API_DOMAIN}/api" >> $GITHUB_ENV
            exit 0
          fi
          ALB_DNS=$(aws cloudformation describe-stacks \
            --stack-name "${APP_STACK_NAME}" \
            --query "Stacks[0].Outputs[?OutputKey=='AlbDns'].OutputValue" \
            --output text)
          echo "EXPO_PUBLIC_API_BASE=https://${ALB_DNS}/api" >> $GITHUB_ENV
      - name: Build Expo web
        run: |
          cd mobile
          npm ci
          EXPO_PUBLIC_API_BASE="${EXPO_PUBLIC_API_BASE}" npx expo export --platform web
      - name: Sync to S3 + invalidate CloudFront
        run: |
          BUCKET=$(aws cloudformation describe-stacks --stack-name $STACK_NAME \
            --query "Stacks[0].Outputs[?OutputKey=='FrontendBucketName'].OutputValue" --output text)
          DIST_ID=$(aws cloudformation describe-stacks --stack-name $STACK_NAME \
            --query "Stacks[0].Outputs[?OutputKey=='FrontendDistributionId'].OutputValue" --output text)
          aws s3 sync mobile/dist s3://$BUCKET --delete
          aws cloudfront create-invalidation --distribution-id $DIST_ID --paths "/*"
