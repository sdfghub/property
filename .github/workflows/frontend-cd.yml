name: frontend-cd
on:
  workflow_dispatch:
env:
  AWS_REGION: eu-central-1
  STACK_NAME: PropertyExpenses-Frontend
  FRONTEND_API_BASE: ${{ secrets.FRONTEND_API_BASE }}
  APP_STACK_NAME: PropertyExpenses-App
jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions: { contents: read, id-token: write }
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: '20' }
      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
      - name: Resolve API base
        run: |
          if [ -n "${FRONTEND_API_BASE}" ]; then
            echo "VITE_API_BASE=${FRONTEND_API_BASE}" >> $GITHUB_ENV
            exit 0
          fi
          ALB_DNS=$(aws cloudformation describe-stacks \
            --stack-name "${APP_STACK_NAME}" \
            --query "Stacks[0].Outputs[?OutputKey=='AlbDns'].OutputValue" \
            --output text)
          echo "VITE_API_BASE=http://${ALB_DNS}/api" >> $GITHUB_ENV
      - run: |
          cd frontend
          npm ci
          npm run build
      - name: Sync to S3 + invalidate CloudFront
        run: |
          BUCKET=$(aws cloudformation describe-stacks --stack-name $STACK_NAME \
            --query "Stacks[0].Outputs[?OutputKey=='FrontendBucketName'].OutputValue" --output text)
          DIST_ID=$(aws cloudformation describe-stacks --stack-name $STACK_NAME \
            --query "Stacks[0].Outputs[?OutputKey=='FrontendDistributionId'].OutputValue" --output text)
          aws s3 sync frontend/dist s3://$BUCKET --delete
          aws cloudfront create-invalidation --distribution-id $DIST_ID --paths "/*"
