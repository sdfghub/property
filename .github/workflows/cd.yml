name: cd
on:
  workflow_dispatch:
env:
  AWS_REGION: eu-central-1
  ECR_REPO: property-expenses-api
jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions: { contents: read, id-token: write }
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: '20' }
      - run: npm ci && npm run generate && npm run build
      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
      - name: Login to ECR
        id: ecr
        uses: aws-actions/amazon-ecr-login@v2
      - name: Build & push image
        run: |
          IMAGE=${{ steps.ecr.outputs.registry }}/${{ env.ECR_REPO }}:${GITHUB_REF_NAME}
          LATEST=${{ steps.ecr.outputs.registry }}/${{ env.ECR_REPO }}:latest
          docker build -t $IMAGE .
          docker tag $IMAGE $LATEST
          docker push $IMAGE
          docker push $LATEST
          echo "IMAGE=$IMAGE" >> $GITHUB_ENV
      - name: Run migrations
        run: |
          CLUSTER=$(aws cloudformation describe-stacks --stack-name PropertyExpenses-App --query "Stacks[0].Outputs[?OutputKey=='ClusterName'].OutputValue" --output text)
          SERVICE=$(aws cloudformation describe-stacks --stack-name PropertyExpenses-App --query "Stacks[0].Outputs[?OutputKey=='ServiceName'].OutputValue" --output text)
          SG=$(aws cloudformation describe-stacks --stack-name PropertyExpenses-App --query "Stacks[0].Outputs[?OutputKey=='ServiceSecurityGroupId'].OutputValue" --output text)
          SUBNETS=$(aws cloudformation describe-stacks --stack-name PropertyExpenses-Network --query "Stacks[0].Outputs[?OutputKey=='PrivateSubnetIds'].OutputValue" --output text)
          TASK_DEF=$(aws ecs describe-services --cluster $CLUSTER --services $SERVICE --query "services[0].taskDefinition" --output text)
          TASK_ARN=$(aws ecs run-task --cluster $CLUSTER --launch-type FARGATE --task-definition $TASK_DEF \
            --network-configuration "awsvpcConfiguration={subnets=[$SUBNETS],securityGroups=[$SG],assignPublicIp=DISABLED}" \
            --overrides '{"containerOverrides":[{"name":"Api","command":["/bin/sh","-c","npx prisma migrate deploy"]}]}' \
            --query "tasks[0].taskArn" --output text)
          aws ecs wait tasks-stopped --cluster $CLUSTER --tasks $TASK_ARN
      - name: Update ECS service
        run: |
          CLUSTER=$(aws cloudformation describe-stacks --stack-name PropertyExpenses-App --query "Stacks[0].Outputs[?OutputKey=='ClusterName'].OutputValue" --output text)
          SERVICE=$(aws cloudformation describe-stacks --stack-name PropertyExpenses-App --query "Stacks[0].Outputs[?OutputKey=='ServiceName'].OutputValue" --output text)
          aws ecs update-service --cluster $CLUSTER --service $SERVICE --force-new-deployment
