datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

enum SeriesScope {
  UNIT
  GROUP
  COMMUNITY
}

enum SeriesOrigin {
  METER
  DECLARATION
  ADMIN
  DERIVED
}

enum AllocationMethod {
  EQUAL
  BY_SQM
  BY_RESIDENTS
  BY_CONSUMPTION
  MIXED
}

enum ExpenseTargetType {
  COMMUNITY
  GROUP
  EXPLICIT_SET
  UNIT
}

enum DocSource {
  MANUAL
  OCR
  IMPORT
  API
}

enum SplitMethod {
  EQUAL
  DAYS
  WEIGHTED_MANUAL
  CUSTOM
}

enum EntityType {
  COMMUNITY
  PERIOD
  UNIT
  GROUP
  BILLING_ENTITY
  SERIES
  EXPENSE
  EXPENSE_TYPE
  VENDOR
  VENDOR_INVOICE
  RULE
  MEASURE_TYPE
}

enum NodeKind {
  COMMUNITY
  GROUP
  UNIT
  SET
}

model Community {
  id       String @id @map("id")
  code     String
  name     String @map("name")
  timezone String @default("Europe/Bucharest") @map("timezone")

  periods                    Period[]
  units                      Unit[]
  groups                     UnitGroup[]
  billingEntities            BillingEntity[]
  rules                      AllocationRule[]
  expenseTypes               ExpenseType[]
  periodMeasures             PeriodMeasure[]
  expenses                   Expense[]
  bills                      Bill[]
  vendors                    Vendor[]
  invoices                   VendorInvoice[]
  externalRefs               ExternalRef[]
  MeasureSeries              MeasureSeries[]
  WeightVector               WeightVector[]
  ExpenseTargetSet           ExpenseTargetSet[]
  AllocationLine             AllocationLine[]
  AllocationLog              AllocationLog[]
  ExpenseSplit               ExpenseSplit[]
  AggregationRule            AggregationRule[]
  DerivedMeterRule           DerivedMeterRule[]
  SplitGroup                 SplitGroup[]
  BucketRule                 BucketRule[]
  Program                    Program[]
  Payment                    Payment[]
  BillTemplate               BillTemplate[]
  BillTemplateInstance       BillTemplateInstance[]
  MeterEntryTemplate         MeterEntryTemplate[]
  MeterEntryTemplateInstance MeterEntryTemplateInstance[]

  @@map("community")
}

enum PeriodStatus {
  DRAFT
  OPEN
  PREPARED
  CLOSED
}

model Period {
  id          String       @id @default(cuid()) @map("id")
  communityId String       @map("community_id")
  code        String       @map("code")
  startDate   DateTime     @map("start_date")
  endDate     DateTime     @map("end_date")
  seq         Int          @map("seq")
  timezone    String       @default("Europe/Bucharest") @map("timezone")
  status      PeriodStatus @default(OPEN)
  preparedAt  DateTime?    @map("prepared_at")
  closedAt    DateTime?    @map("closed_at")

  community                  Community                    @relation(fields: [communityId], references: [id])
  PeriodMeasure              PeriodMeasure[]
  WeightVector               WeightVector[]
  Expense                    Expense[]
  AllocationLine             AllocationLine[]
  Bill                       Bill[]
  InvoiceSplit               InvoiceSplit[]
  AllocationLog              AllocationLog[]
  ExpenseSplit               ExpenseSplit[]
  // AllocationLineDetail removed
  BillTemplateInstance       BillTemplateInstance[]
  MeterEntryTemplateInstance MeterEntryTemplateInstance[]

  @@unique([communityId, code])
  @@unique([communityId, seq])
  @@index([communityId, startDate, endDate])
  @@map("period")
}

model Unit {
  id          String @id @default(cuid()) @map("id")
  communityId String @map("community_id")
  code        String @map("code")
  order       Int    @default(0) @map("order")

  community           Community             @relation(fields: [communityId], references: [id])
  UnitGroupMember     UnitGroupMember[]
  BillingEntityMember BillingEntityMember[]
  WeightItem          WeightItem[]
  ExpenseTargetMember ExpenseTargetMember[]
  AllocationLine      AllocationLine[]
  // AllocationLineDetail removed
  BeLedgerEntryDetail BeLedgerEntryDetail[]

  @@unique([code, communityId])
  @@index([communityId])
  @@map("unit")
}

model UnitGroup {
  id          String @id @default(cuid()) @map("id")
  communityId String @map("community_id")
  code        String @map("code")
  name        String @map("name")

  community Community         @relation(fields: [communityId], references: [id])
  members   UnitGroupMember[]

  @@unique([code, communityId])
  @@index([communityId])
  @@map("unit_group")
}

model UnitGroupMember {
  id            String  @id @default(cuid()) @map("id")
  groupId       String  @map("group_id")
  unitId        String  @map("unit_id")
  startPeriodId String  @map("start_period_id")
  endPeriodId   String? @map("end_period_id")
  startSeq      Int     @map("start_seq")
  endSeq        Int?    @map("end_seq")

  group UnitGroup @relation(fields: [groupId], references: [id])
  unit  Unit      @relation(fields: [unitId], references: [id])

  @@index([groupId, startSeq, endSeq])
  @@index([unitId, startSeq, endSeq])
  @@map("unit_group_member")
}

model BillingEntity {
  id          String @id @default(cuid()) @map("id")
  communityId String @map("community_id")
  code        String @map("code")
  order       Int    @default(0) @map("order")
  name        String @map("name")

  community Community             @relation(fields: [communityId], references: [id])
  members   BillingEntityMember[]
  bills     Bill[]
  Payment   Payment[]

  @@unique([code, communityId])
  @@index([communityId])
  @@map("billing_entity")
}

model BillingEntityMember {
  id              String  @id @default(cuid()) @map("id")
  billingEntityId String  @map("billing_entity_id")
  unitId          String  @map("unit_id")
  startPeriodId   String  @map("start_period_id")
  endPeriodId     String? @map("end_period_id")
  startSeq        Int     @map("start_seq")
  endSeq          Int?    @map("end_seq")

  billingEntity BillingEntity @relation(fields: [billingEntityId], references: [id])
  unit          Unit          @relation(fields: [unitId], references: [id])

  @@index([billingEntityId, startSeq, endSeq])
  @@index([unitId, startSeq, endSeq])
  @@map("billing_entity_member")
}

model MeasureType {
  code   String          @id @map("code")
  name   String?         @map("name")
  unit   String          @map("unit")
  series MeasureSeries[]

  @@map("measure_type")
}

model MeasureSeries {
  id          String       @id @default(cuid()) @map("id")
  communityId String       @map("community_id")
  scope       SeriesScope  @map("scope")
  scopeId     String       @map("scope_id")
  typeCode    String       @map("type_code")
  origin      SeriesOrigin @map("origin")

  community    Community            @relation(fields: [communityId], references: [id])
  type         MeasureType          @relation(fields: [typeCode], references: [code])
  samples      MeasureSample[]
  periodValues MeasurePeriodValue[]

  @@index([communityId, scope, scopeId, typeCode])
  @@map("measure_series")
}

model MeasureSample {
  id        String   @id @default(cuid()) @map("id")
  seriesId  String   @map("series_id")
  ts        DateTime @map("ts")
  value     Decimal  @map("value") @db.Decimal(18, 6)
  estimated Boolean  @default(false) @map("estimated")

  series MeasureSeries @relation(fields: [seriesId], references: [id])

  @@index([seriesId, ts])
  @@map("measure_sample")
}

model MeasurePeriodValue {
  id            String  @id @default(cuid()) @map("id")
  seriesId      String  @map("series_id")
  startPeriodId String  @map("start_period_id")
  endPeriodId   String? @map("end_period_id")
  startSeq      Int     @map("start_seq")
  endSeq        Int?    @map("end_seq")
  value         Decimal @map("value") @db.Decimal(18, 6)

  series MeasureSeries @relation(fields: [seriesId], references: [id])

  @@index([seriesId, startSeq, endSeq])
  @@map("measure_period_value")
}

model PeriodMeasure {
  id          String       @id @default(cuid()) @map("id")
  communityId String       @map("community_id")
  periodId    String       @map("period_id")
  meterId     String       @map("meter_id")
  scopeType   SeriesScope  @map("scope_type")
  scopeId     String       @map("scope_id")
  typeCode    String       @map("type_code")
  origin      SeriesOrigin @map("origin")
  value       Decimal      @map("value") @db.Decimal(18, 6)
  estimated   Boolean      @default(false) @map("estimated")
  provenance  Json?        @map("provenance")

  community Community @relation(fields: [communityId], references: [id])
  period    Period    @relation(fields: [periodId], references: [id])

  @@unique([communityId, periodId, scopeType, scopeId, typeCode])
  @@index([meterId])
  @@index([periodId, typeCode])
  @@map("period_measure")
}

model AllocationRule {
  id          String           @id @default(cuid()) @map("id")
  communityId String           @map("community_id")
  method      AllocationMethod @map("method")
  name        String?          @map("name")
  params      Json?            @map("params")

  community    Community      @relation(fields: [communityId], references: [id])
  vectors      WeightVector[]
  expenseTypes ExpenseType[]

  @@map("allocation_rule")
}

model WeightVector {
  id          String            @id @default(cuid()) @map("id")
  communityId String            @map("community_id")
  periodId    String            @map("period_id")
  ruleId      String            @map("rule_id")
  scopeType   ExpenseTargetType @map("scope_type")
  scopeId     String            @map("scope_id")

  expenseId String?  @unique @map("expense_id")
  expense   Expense? @relation("ExpenseVector", fields: [expenseId], references: [id])

  community Community      @relation(fields: [communityId], references: [id])
  period    Period         @relation(fields: [periodId], references: [id])
  rule      AllocationRule @relation(fields: [ruleId], references: [id])
  items     WeightItem[]

  @@unique([communityId, periodId, ruleId, scopeType, scopeId, expenseId])
  @@map("weight_vector")
}

model WeightItem {
  id       String  @id @default(cuid()) @map("id")
  vectorId String  @map("vector_id")
  unitId   String  @map("unit_id")
  rawValue Decimal @map("raw_value") @db.Decimal(18, 6)
  weight   Decimal @map("weight") @db.Decimal(18, 12)

  vector WeightVector @relation(fields: [vectorId], references: [id])
  unit   Unit         @relation(fields: [unitId], references: [id])

  @@unique([vectorId, unitId])
  @@map("weight_item")
}

model ExpenseType {
  id          String  @id @default(cuid()) @map("id")
  communityId String  @map("community_id")
  code        String  @map("code")
  name        String  @map("name")
  ruleId      String  @map("rule_id")
  params      Json?   @map("params")
  currency    String? @map("currency")

  community Community      @relation(fields: [communityId], references: [id])
  rule      AllocationRule @relation(fields: [ruleId], references: [id])
  Expense   Expense[]

  @@unique([code, communityId])
  @@map("expense_type")
}

model Expense {
  id                String            @id @default(cuid()) @map("id")
  communityId       String            @map("community_id")
  periodId          String            @map("period_id")
  description       String            @map("description")
  allocatableAmount Decimal           @map("allocatable_amount") @db.Decimal(18, 4)
  currency          String            @default("RON") @map("currency")
  targetType        ExpenseTargetType @map("target_type")
  targetId          String            @map("target_id")
  expenseTypeId     String?           @map("expense_type_id")
  invoiceId         String?           @map("invoice_id")
  invoiceLineKey    String?           @map("invoice_line_key")
  weightVectorId    String?           @map("weight_vector_id")

  community     Community        @relation(fields: [communityId], references: [id])
  period        Period           @relation(fields: [periodId], references: [id])
  expenseType   ExpenseType?     @relation(fields: [expenseTypeId], references: [id])
  allocations   AllocationLine[]
  weightVector  WeightVector?    @relation("ExpenseVector")
  AllocationLog AllocationLog[]
  BillLine      BillLine[]
  ExpenseSplit  ExpenseSplit[]

  @@index([communityId, periodId])
  @@index([targetType, targetId])
  @@map("expense")
}

model AllocationLog {
  id          String   @id @default(cuid()) @map("id")
  communityId String   @map("community_id")
  periodId    String   @map("period_id")
  expenseId   String   @map("expense_id")
  message     String   @map("message")
  details     Json?    @map("details")
  createdAt   DateTime @default(now()) @map("created_at")

  community Community @relation(fields: [communityId], references: [id])
  period    Period    @relation(fields: [periodId], references: [id])
  expense   Expense   @relation(fields: [expenseId], references: [id])

  @@index([expenseId])
  @@map("allocation_log")
}

model ExpenseTargetSet {
  id          String  @id @default(cuid()) @map("id")
  communityId String  @map("community_id")
  name        String? @map("name")

  community Community             @relation(fields: [communityId], references: [id])
  members   ExpenseTargetMember[]

  @@index([communityId])
  @@map("expense_target_set")
}

model ExpenseTargetMember {
  id     String @id @default(cuid()) @map("id")
  setId  String @map("set_id")
  unitId String @map("unit_id")

  set  ExpenseTargetSet @relation(fields: [setId], references: [id])
  unit Unit             @relation(fields: [unitId], references: [id])

  @@unique([setId, unitId])
  @@map("expense_target_member")
}

model AllocationLine {
  id             String  @id @default(cuid()) @map("id")
  communityId    String  @map("community_id")
  periodId       String  @map("period_id")
  expenseId      String  @map("expense_id")
  unitId         String  @map("unit_id")
  expenseSplitId String? @map("expense_split_id")
  splitNodeId    String? @map("split_node_id")
  amount         Decimal @map("amount") @db.Decimal(18, 4)
  meta           Json?   @map("meta")

  community    Community     @relation(fields: [communityId], references: [id])
  period       Period        @relation(fields: [periodId], references: [id])
  expense      Expense       @relation(fields: [expenseId], references: [id])
  unit         Unit          @relation(fields: [unitId], references: [id])
  expenseSplit ExpenseSplit? @relation(fields: [expenseSplitId], references: [id])

  @@unique([expenseId, unitId, expenseSplitId])
  @@index([communityId, periodId])
  @@index([expenseId])
  @@index([unitId, periodId])
  @@index([splitNodeId])
  @@map("allocation_line")
}

model SplitGroup {
  id          String @id @default(cuid()) @map("id")
  communityId String @map("community_id")
  code        String @map("code")
  name        String @map("name")
  order       Int?   @map("order")

  community Community          @relation(fields: [communityId], references: [id])
  members   SplitGroupMember[]

  @@unique([communityId, code])
  @@index([communityId])
  @@map("split_group")
}

model SplitGroupMember {
  id           String @id @default(cuid()) @map("id")
  splitGroupId String @map("split_group_id")
  splitNodeId  String @map("split_node_id")

  splitGroup SplitGroup @relation(fields: [splitGroupId], references: [id])

  @@unique([splitGroupId, splitNodeId])
  @@index([splitNodeId])
  @@map("split_group_member")
}

model BucketRule {
  id               String  @id @default(cuid()) @map("id")
  communityId      String  @map("community_id")
  code             String  @map("code")
  name             String  @map("name")
  programCode      String? @map("program_code")
  expenseTypeCodes Json?   @map("expense_type_codes")
  splitGroupCodes  Json?   @map("split_group_codes")
  splitNodeIds     Json?   @map("split_node_ids")
  priority         Int     @default(1) @map("priority")

  community Community @relation(fields: [communityId], references: [id])

  @@unique([communityId, code])
  @@index([communityId])
  @@map("bucket_rule")
}

model Program {
  id              String   @id @default(cuid()) @map("id")
  communityId     String   @map("community_id")
  code            String   @map("code")
  name            String   @map("name")
  description     String?  @map("description")
  status          String   @default("PLANNED") @map("status")
  currency        String   @default("RON") @map("currency")
  totalTarget     Decimal? @map("total_target") @db.Decimal(18, 2)
  startPeriodCode String?  @map("start_period_code")
  targetPlan      Json?    @map("target_plan")
  targets         Json?    @map("targets")
  defaultBucket   String?  @map("default_bucket")
  allocation      Json?    @map("allocation")

  community Community @relation(fields: [communityId], references: [id])

  @@unique([communityId, code])
  @@index([communityId])
  @@map("program")
}

model AggregationRule {
  id           String  @id @default(cuid()) @map("id")
  communityId  String  @map("community_id")
  targetType   String  @map("target_type")
  unitTypes    Json    @map("unit_types")
  residualType String? @map("residual_type")
  totalType    String? @map("total_type")

  community Community @relation(fields: [communityId], references: [id])

  @@unique([communityId, targetType])
  @@index([communityId])
  @@map("aggregation_rule")
}

model DerivedMeterRule {
  id            String       @id @default(cuid()) @map("id")
  communityId   String       @map("community_id")
  scopeType     SeriesScope  @default(COMMUNITY) @map("scope_type")
  sourceType    String       @map("source_type")
  subtractTypes Json         @map("subtract_types")
  targetType    String       @map("target_type")
  origin        SeriesOrigin @default(DERIVED) @map("origin")

  community Community @relation(fields: [communityId], references: [id])

  @@unique([communityId, scopeType, sourceType, targetType])
  @@index([communityId])
  @@map("derived_meter_rule")
}

model ExpenseSplit {
  id            String   @id @default(cuid()) @map("id")
  communityId   String   @map("community_id")
  periodId      String   @map("period_id")
  expenseId     String   @map("expense_id")
  parentSplitId String?  @map("parent_split_id")
  share         Decimal? @map("share") @db.Decimal(18, 6)
  amount        Decimal  @map("amount") @db.Decimal(18, 4)
  basisType     String?  @map("basis_type")
  basisCode     String?  @map("basis_code")
  meta          Json?    @map("meta")

  community   Community        @relation(fields: [communityId], references: [id])
  period      Period           @relation(fields: [periodId], references: [id])
  expense     Expense          @relation(fields: [expenseId], references: [id])
  parent      ExpenseSplit?    @relation("SplitParent", fields: [parentSplitId], references: [id])
  children    ExpenseSplit[]   @relation("SplitParent")
  allocations AllocationLine[]

  @@index([expenseId])
  @@index([parentSplitId])
  @@map("expense_split")
}

model Meter {
  meterId     String    @id @map("meter_id")
  scopeType   String    @map("scope_type")
  scopeCode   String    @map("scope_code")
  typeCode    String    @map("type_code")
  origin      String    @default("METER") @map("origin")
  installedAt DateTime? @map("installed_at")
  retiredAt   DateTime? @map("retired_at")
  multiplier  Decimal?  @map("multiplier") @db.Decimal(18, 6)
  notes       String?   @map("notes")

  @@index([scopeCode])
  @@index([typeCode])
  @@map("meter")
}

model Bill {
  id              String  @id @default(cuid()) @map("id")
  communityId     String  @map("community_id")
  periodId        String  @map("period_id")
  billingEntityId String  @map("billing_entity_id")
  totalAmount     Decimal @map("total_amount") @db.Decimal(18, 4)

  community     Community     @relation(fields: [communityId], references: [id])
  period        Period        @relation(fields: [periodId], references: [id])
  billingEntity BillingEntity @relation(fields: [billingEntityId], references: [id])
  lines         BillLine[]

  @@unique([communityId, periodId, billingEntityId])
  @@map("bill")
}

model BillLine {
  id        String  @id @default(cuid()) @map("id")
  billId    String  @map("bill_id")
  expenseId String  @map("expense_id")
  amount    Decimal @map("amount") @db.Decimal(18, 4)
  meta      Json?   @map("meta")

  bill    Bill    @relation(fields: [billId], references: [id])
  expense Expense @relation(fields: [expenseId], references: [id])

  @@index([billId])
  @@index([expenseId])
  @@map("bill_line")
}

model Vendor {
  id          String  @id @default(cuid()) @map("id")
  communityId String  @map("community_id")
  name        String  @map("name")
  taxId       String? @map("tax_id")
  iban        String? @map("iban")

  community     Community       @relation(fields: [communityId], references: [id])
  VendorInvoice VendorInvoice[]

  @@unique([communityId, name])
  @@map("vendor")
}

model VendorInvoice {
  id                   String    @id @default(cuid()) @map("id")
  communityId          String    @map("community_id")
  vendorId             String?   @map("vendor_id")
  number               String?   @map("number")
  issueDate            DateTime? @map("issue_date")
  serviceStartPeriodId String?   @map("service_start_period_id")
  serviceEndPeriodId   String?   @map("service_end_period_id")
  currency             String    @default("RON") @map("currency")
  net                  Decimal?  @map("net") @db.Decimal(18, 4)
  vat                  Decimal?  @map("vat") @db.Decimal(18, 4)
  gross                Decimal?  @map("gross") @db.Decimal(18, 4)
  source               DocSource @default(MANUAL) @map("source")
  hash                 String?   @map("hash")
  provenance           Json?     @map("provenance")

  community Community          @relation(fields: [communityId], references: [id])
  vendor    Vendor?            @relation(fields: [vendorId], references: [id])
  docs      VendorInvoiceDoc[]
  splits    InvoiceSplit[]

  @@index([communityId, number])
  @@map("vendor_invoice")
}

model VendorInvoiceDoc {
  id         String    @id @default(cuid()) @map("id")
  invoiceId  String    @map("invoice_id")
  url        String    @map("url")
  mime       String?   @map("mime")
  bytes      Int?      @map("bytes")
  sha256     String?   @map("sha256")
  uploadedAt DateTime  @default(now()) @map("uploaded_at")
  source     DocSource @default(MANUAL) @map("source")

  invoice VendorInvoice @relation(fields: [invoiceId], references: [id])

  @@map("vendor_invoice_doc")
}

model InvoiceSplit {
  id          String      @id @default(cuid()) @map("id")
  invoiceId   String      @map("invoice_id")
  periodId    String      @map("period_id")
  method      SplitMethod @map("method")
  share       Decimal     @map("share") @db.Decimal(18, 8)
  allocatable Decimal     @map("allocatable") @db.Decimal(18, 4)
  provenance  Json?       @map("provenance")

  invoice VendorInvoice @relation(fields: [invoiceId], references: [id])
  period  Period        @relation(fields: [periodId], references: [id])

  @@unique([invoiceId, periodId])
  @@index([periodId])
  @@map("invoice_split")
}

// --------- Bill templates (declarative UI mappings for bills per period) ---------
model BillTemplate {
  id              String   @id @default(cuid()) @map("id")
  communityId     String   @map("community_id")
  code            String   @map("code")
  name            String   @map("name")
  order           Int?     @map("order")
  startPeriodCode String?  @map("start_period_code")
  endPeriodCode   String?  @map("end_period_code")
  template        Json     @map("template")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  community Community              @relation(fields: [communityId], references: [id])
  instances BillTemplateInstance[]

  @@unique([communityId, code])
  @@index([communityId])
  @@map("bill_template")
}

model BillTemplateInstance {
  id          String   @id @default(cuid()) @map("id")
  communityId String   @map("community_id")
  periodId    String   @map("period_id")
  templateId  String   @map("template_id")
  state       String   @default("NEW") @map("state")
  values      Json?    @map("values")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  community Community    @relation(fields: [communityId], references: [id])
  period    Period       @relation(fields: [periodId], references: [id])
  template  BillTemplate @relation(fields: [templateId], references: [id])

  @@unique([communityId, periodId, templateId])
  @@index([periodId])
  @@map("bill_template_instance")
}

// --------- Meter entry templates (grouped meter inputs per period) ----------
model MeterEntryTemplate {
  id              String   @id @default(cuid()) @map("id")
  communityId     String   @map("community_id")
  code            String   @map("code")
  name            String   @map("name")
  order           Int?     @map("order")
  startPeriodCode String?  @map("start_period_code")
  endPeriodCode   String?  @map("end_period_code")
  template        Json     @map("template")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  community Community                    @relation(fields: [communityId], references: [id])
  instances MeterEntryTemplateInstance[]

  @@unique([communityId, code])
  @@index([communityId])
  @@map("meter_entry_template")
}

model MeterEntryTemplateInstance {
  id          String   @id @default(cuid()) @map("id")
  communityId String   @map("community_id")
  periodId    String   @map("period_id")
  templateId  String   @map("template_id")
  state       String   @default("NEW") @map("state")
  values      Json?    @map("values")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  community Community          @relation(fields: [communityId], references: [id])
  period    Period             @relation(fields: [periodId], references: [id])
  template  MeterEntryTemplate @relation(fields: [templateId], references: [id])

  @@unique([communityId, periodId, templateId])
  @@index([periodId])
  @@map("meter_entry_template_instance")
}

// Attachments linked to bill or meter templates (per period).
model TemplateAttachment {
  id           String   @id @default(cuid()) @map("id")
  communityId  String   @map("community_id")
  periodId     String   @map("period_id")
  templateType String   @map("template_type") // BILL or METER
  templateCode String   @map("template_code")
  fileName     String   @map("file_name")
  contentType  String?  @map("content_type")
  size         Int?     @map("size")
  data         Bytes?   @map("data")
  createdAt    DateTime @default(now()) @map("created_at")

  @@index([communityId, periodId, templateType, templateCode])
  @@map("template_attachment")
}

model ExternalRef {
  id           String     @id @default(cuid()) @map("id")
  communityId  String     @map("community_id")
  entityType   EntityType @map("entity_type")
  entityId     String     @map("entity_id")
  sourceSystem String     @map("source_system")
  legacyId     String     @map("legacy_id")
  validFrom    DateTime   @default(now()) @map("valid_from")
  validTo      DateTime?  @map("valid_to")

  community Community @relation(fields: [communityId], references: [id])

  @@unique([communityId, sourceSystem, legacyId])
  @@index([entityType, entityId])
  @@map("external_ref")
}

// ---------- Opening balance per BE & period ----------
model BeOpeningBalance {
  id              String   @id @default(cuid()) @map("id")
  communityId     String   @map("community_id")
  periodId        String   @map("period_id")
  billingEntityId String   @map("billing_entity_id")
  amount          Decimal  @default(0) @map("amount")
  currency        String   @default("RON") @map("currency")
  createdAt       DateTime @default(now()) @map("created_at")

  @@unique([communityId, periodId, billingEntityId])
  @@map("be_opening_balance")
}

// ---------- Ledger (charges, payments, adjustments) ----------

model BeLedgerEntryDetail {
  id            String  @id @default(cuid()) @map("id")
  ledgerEntryId String  @map("ledger_entry_id")
  unitId        String? @map("unit_id")
  amount        Decimal @map("amount") @db.Decimal(18, 4)
  meta          Json?   @map("meta")

  ledger BeLedgerEntry @relation(fields: [ledgerEntryId], references: [id])
  unit   Unit?         @relation(fields: [unitId], references: [id])

  @@index([ledgerEntryId])
  @@index([unitId])
  @@map("be_ledger_entry_detail")
}

model BeLedgerEntry {
  id              String   @id @default(cuid()) @map("id")
  communityId     String   @map("community_id")
  periodId        String   @map("period_id")
  billingEntityId String   @map("billing_entity_id")
  kind            String   @map("kind") // 'CHARGE' | 'PAYMENT' | 'ADJUSTMENT'
  amount          Decimal  @default(0) @map("amount")
  currency        String   @default("RON") @map("currency")
  bucket          String   @default("ALLOCATED_EXPENSE") @map("bucket")
  refType         String?  @map("ref_type") // 'CLOSE_PREP' | 'CLOSE_FINAL' | ...
  refId           String?  @map("ref_id")
  createdAt       DateTime @default(now()) @map("created_at")

  details             BeLedgerEntryDetail[]
  paymentApplications PaymentApplication[]

  @@unique([communityId, periodId, billingEntityId, refType, refId, bucket])
  @@index([communityId, periodId, billingEntityId])
  @@index([communityId, bucket])
  @@map("be_ledger_entry")
}

// ---------- Payments ----------
model Payment {
  id              String   @id @default(cuid()) @map("id")
  communityId     String   @map("community_id")
  billingEntityId String   @map("billing_entity_id")
  amount          Decimal  @map("amount") @db.Decimal(18, 4)
  currency        String   @default("RON") @map("currency")
  ts              DateTime @default(now()) @map("ts")
  method          String?  @map("method")
  refId           String?  @unique @map("ref_id")

  community    Community            @relation(fields: [communityId], references: [id])
  billing      BillingEntity        @relation(fields: [billingEntityId], references: [id])
  applications PaymentApplication[]

  @@index([communityId, billingEntityId])
  @@map("payment")
}

model PaymentApplication {
  id        String   @id @default(cuid()) @map("id")
  paymentId String   @map("payment_id")
  chargeId  String   @map("charge_id")
  amount    Decimal  @map("amount") @db.Decimal(18, 4)
  createdAt DateTime @default(now()) @map("created_at")

  payment Payment       @relation(fields: [paymentId], references: [id])
  charge  BeLedgerEntry @relation(fields: [chargeId], references: [id])

  @@index([chargeId])
  @@index([paymentId])
  @@map("payment_application")
}

// ---------- Statement (snapshot at close/prepare) ----------
model BeStatement {
  id              String  @id @default(cuid()) @map("id")
  communityId     String  @map("community_id")
  periodId        String  @map("period_id")
  billingEntityId String  @map("billing_entity_id")
  currency        String  @default("RON") @map("currency")
  dueStart        Decimal @default(0) @map("due_start")
  charges         Decimal @default(0) @map("charges")
  payments        Decimal @default(0) @map("payments")
  adjustments     Decimal @default(0) @map("adjustments")
  dueEnd          Decimal @default(0) @map("due_end")

  @@unique([communityId, periodId, billingEntityId])
  @@map("be_statement")
}

model User {
  id            String           @id @default(cuid())
  email         String           @unique
  name          String?
  createdAt     DateTime         @default(now()) @map("created_at")
  tokenVersion  Int              @default(0) @map("token_version")
  roles         RoleAssignment[]
  invites       Invite[]
  loginTokens   LoginToken[]
  refreshTokens RefreshToken[]

  @@map("user")
}

enum Role {
  SYSTEM_ADMIN
  COMMUNITY_ADMIN
  CENSOR
  BILLING_ENTITY_USER
}

enum ScopeType {
  SYSTEM
  COMMUNITY
  BILLING_ENTITY
}

model RoleAssignment {
  id        String    @id @default(cuid())
  userId    String    @map("user_id")
  role      Role
  scopeType ScopeType @map("scope_type")
  scopeId   String?
  createAt  DateTime  @default(now())
  user      User      @relation(fields: [userId], references: [id])

  @@unique([userId, role, scopeType, scopeId])
  @@map("role_assignment")
}

model Invite {
  id         String    @id @default(cuid())
  email      String
  role       Role
  userId     String?   @map("user_id")
  scopeType  ScopeType @map("scope_type")
  scopeId    String?   @map("scope_id")
  invitedBy  String    @map("invited_by")
  token      String    @unique
  expiresAt  DateTime  @map("expires_at")
  acceptedAt DateTime? @map("accepted_at")
  createdAt  DateTime  @default(now()) @map("created_at")
  user       User?     @relation(fields: [userId], references: [id])

  @@map("invite")
}

model LoginToken {
  id        String    @id @default(cuid())
  email     String
  token     String    @unique
  usedAt    DateTime? @map("used_at")
  expiresAt DateTime? @map("expires_at")
  createdAt DateTime  @default(now()) @map("created_at")
  user      User?     @relation(fields: [userId], references: [id])
  userId    String?   @map("user_id")

  @@map("login_token")
}

model RefreshToken {
  id        String    @id @default(cuid())
  userId    String    @map("user_id")
  jti       String    @unique
  tokenHash String    @unique @map("token_hash")
  userAgent String?   @map("user_agent")
  ip        String?
  expiresAt DateTime  @map("expires_at")
  revokedAt DateTime? @map("revoked_at")
  createdAt DateTime  @default(now()) @map("created_at")
  user      User      @relation(fields: [userId], references: [id])

  @@index([userId])
  @@map("refresh_token")
}
